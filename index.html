<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Sistema Premium S77</title>
<style>
body{background:black;color:white;font-family:Arial;text-align:center}
.inputs{display:grid;grid-template-columns:repeat(4,70px);gap:10px;justify-content:center}
.inputs input,.box{width:70px;height:70px;font-size:32px;text-align:center;font-weight:bold}
.box{background:#7fd3ff;border:4px solid red}
.favoritos{background:green;padding:10px}
.explosivos{background:red;padding:10px;font-size:40px}
</style>
</head>
<body>

<h2>ÚLTIMOS 16</h2>
<div class="inputs">
<input disabled><input disabled><input disabled><input disabled>
<input disabled><input disabled><input disabled><input disabled>
<input disabled><input disabled><input disabled><input disabled>
<input disabled><input disabled><input disabled><input disabled>
</div>

<h3>NUEVO NÚMERO</h3>
<div style="display:flex;justify-content:center;gap:20px">
<input id="nuevo" class="box" type="number">
<div>
<div>FICHAS</div>
<input id="fichas" class="box" value="1" disabled>
</div>
</div>

<h3>FAVORITOS</h3>
<div id="fav" class="favoritos">—</div>

<h3>EXPLOSIVOS</h3>
<div id="exp" class="explosivos">—</div>

<script>
const lotes3=[[0,13,28],[1,18,36]];
const lotes4=[[3,18,24,26]];

const cas=[...document.querySelectorAll('.inputs input')];
const nuevo=document.getElementById('nuevo');
const fav=document.getElementById('fav');
const exp=document.getElementById('exp');
const fichasInput=document.getElementById('fichas');

let ultimos=[];
let acumulado=0;
let sistemaActivo=false;
let aciertosRegistrados=new Set();

nuevo.onchange=()=>{
  const v=parseInt(nuevo.value);
  if(isNaN(v)) return;

  ultimos.unshift(v);
  if(ultimos.length>16) ultimos.pop();

  if(ultimos.length===16) sistemaActivo=true;

  render();
  if(sistemaActivo) calcular();
  nuevo.value="";
};

function render(){
  cas.forEach((c,i)=>c.value=ultimos[i]??"");
}

function calcular(){
  let cnt={},presentes=[...new Set(ultimos)];
  let nuevoAcierto=false;

  const sumar=n=>cnt[n]=(cnt[n]||0)+1;

  lotes3.forEach((l,i)=>{
    let p=l.filter(n=>presentes.includes(n));
    if(p.length===3 && !aciertosRegistrados.has("3-"+i)){
      aciertosRegistrados.add("3-"+i);
      nuevoAcierto=true;
    }
    if(p.length===2) sumar(l.find(n=>!p.includes(n)));
  });

  lotes4.forEach((l,i)=>{
    let p=l.filter(n=>presentes.includes(n));
    if(p.length===3 && !aciertosRegistrados.has("4-"+i)){
      aciertosRegistrados.add("4-"+i);
      nuevoAcierto=true;
    }
    if(p.length===2){
      l.filter(n=>!p.includes(n)).forEach(sumar);
    }
  });

  let f=[],e=[];
  for(let n in cnt) cnt[n]>1?e.push(n):f.push(n);

  fav.innerText=f.length?f.join(", "):"—";
  exp.innerText=e.length?e.join(", "):"—";

  if(nuevoAcierto){
    acumulado=0;
    fichasInput.value=1;
    return;
  }

  acumulado+=f.length+e.length;
  fichasInput.value=Math.floor(acumulado/25)+1;
}
</script>

</body>
</html>
